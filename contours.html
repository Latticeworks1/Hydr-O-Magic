<!DOCTYPE html>
<html>
<head>
  <title>Interactive Leaflet and Plotly Map</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
    }
    h3 {
      margin-top: 20px;
      margin-bottom: 10px;
    }
  </style>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
  <h3>Data Table</h3>
  <table id="dataTable">
    <tr>
      <th>Latitude</th>
      <th>Longitude</th>
      <th>Elevation</th>
    </tr>
  </table>
  <label for="contourStep">Contour Step: </label>
  <input type="number" id="contourStep" value="0.25">
  <button onclick="updatePlotBasedOnMapView()">Update Plot</button>
  <h3>Plotly Contour Plot</h3>
  <div id="plotDiv" style="width: 600px; height: 400px;"></div>
  <h3>Leaflet Map</h3>
  <div id="map" style="width: 600px; height: 400px;"></div>

  <script>
    // Initialize Leaflet map
    var map = L.map('map').setView([51.505, -0.09], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    // Initialize data table
    var dataTable = document.getElementById('dataTable');
    var plotData = [];

    function updatePlotBasedOnMapView() {
      var bounds = map.getBounds();
      var maxLat = bounds.getNorth();
      var minLat = bounds.getSouth();
      var maxLng = bounds.getEast();
      var minLng = bounds.getWest();
      var contourStep = parseFloat(document.getElementById('contourStep').value);

      var zMin = Math.min(...plotData.map(d => d[2]));
      var zMax = Math.max(...plotData.map(d => d[2]));

      var contourStart = Math.ceil(zMin / contourStep) * contourStep;
      var contourEnd = Math.floor(zMax / contourStep) * contourStep;

      if (contourStep <= 0 || contourStart > contourEnd) {
        return;
      }

      var contourTrace = {
        type: 'contour',
        z: plotData.map(d => d[2]),
        x: plotData.map(d => d[1]), // Switched to Longitude
        y: plotData.map(d => d[0]), // Switched to Latitude
        contours: {
          start: contourStart,
          end: contourEnd,
          size: contourStep
        }
      };

      var pointTrace = {
        type: 'scatter',
        mode: 'markers',
        x: plotData.map(d => d[1]), // Switched to Longitude
        y: plotData.map(d => d[0]), // Switched to Latitude
        marker: { color: 'red', size: 10 },
        name: 'Points'
      };

      var layout = {
        xaxis: {
          range: [minLng, maxLng],
          title: 'Longitude'
        },
        yaxis: {
          range: [minLat, maxLat],
          title: 'Latitude'
        }
      };

      Plotly.newPlot('plotDiv', [contourTrace, pointTrace], layout);
    }

    map.on('moveend', updatePlotBasedOnMapView);

    map.on('click', function(e) {
      var lat = e.latlng.lat;
      var lng = e.latlng.lng;

      L.marker([lat, lng]).addTo(map);

      var row = dataTable.insertRow(-1);
      var cell1 = row.insertCell(0);
      var cell2 = row.insertCell(1);
      var cell3 = row.insertCell(2);
      cell1.innerHTML = lat;
      cell2.innerHTML = lng;
      cell3.innerHTML = '<input type="number" class="elevation">';

      cell3.querySelector('.elevation').addEventListener('change', function() {
        var elevation = parseFloat(this.value);
        plotData.push([lat, lng, elevation]);
        updatePlotBasedOnMapView();
      });
    });

    updatePlotBasedOnMapView();
  </script>
</body>
</html>
